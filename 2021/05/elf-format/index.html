<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-180x180-pk.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-pk.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-pk.png">
  <link rel="mask-icon" href="/images/pk-18x18.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pkemb.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ELF文件格式说明，以及objdump和readelf指令的常用选项。">
<meta property="og:type" content="article">
<meta property="og:title" content="ELF文件格式">
<meta property="og:url" content="https://pkemb.com/2021/05/elf-format/index.html">
<meta property="og:site_name" content="熊孩子程序员">
<meta property="og:description" content="ELF文件格式说明，以及objdump和readelf指令的常用选项。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/pkemb/notes/master/books/9787121085116/pic/ELF%E7%9A%84%E9%93%BE%E6%8E%A5%E5%92%8C%E6%89%A7%E8%A1%8C%E8%A7%86%E5%9B%BE.png">
<meta property="og:image" content="https://raw.githubusercontent.com/pkemb/notes/master/books/9787121085116/pic/elf_header.png">
<meta property="article:published_time" content="2021-05-02T10:22:01.000Z">
<meta property="article:modified_time" content="2023-04-28T22:21:48.000Z">
<meta property="article:author" content="pkemb">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/pkemb/notes/master/books/9787121085116/pic/ELF%E7%9A%84%E9%93%BE%E6%8E%A5%E5%92%8C%E6%89%A7%E8%A1%8C%E8%A7%86%E5%9B%BE.png">

<link rel="canonical" href="https://pkemb.com/2021/05/elf-format/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ELF文件格式 | 熊孩子程序员</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <meta name="referrer" content="no-referrer" />
<link rel="alternate" href="/atom.xml" title="熊孩子程序员" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <a target="_blank" rel="noopener" href="https://github.com/pkemb" class="github-corner" aria-label="View source on GitHub">
      <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">熊孩子程序员</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-disk">

    <a href="http://share.pkemb.com/" rel="noopener" target="_blank"><i class="fa fa-file fa-fw"></i>网盘</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="https://notes.pkemb.com/#/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>读书笔记</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pkemb.com/2021/05/elf-format/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="pkemb">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="熊孩子程序员">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ELF文件格式
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-02 10:22:01" itemprop="dateCreated datePublished" datetime="2021-05-02T10:22:01+00:00">2021-05-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-28 22:21:48" itemprop="dateModified" datetime="2023-04-28T22:21:48+00:00">2023-04-28</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ELF文件格式说明，以及objdump和readelf指令的常用选项。</p>
<span id="more"></span>
<h2 id="ELF文件格式概述"><a class="header-anchor" href="#ELF文件格式概述">¶</a>ELF文件格式概述</h2>
<p>ELF文件格式是链接、装载的基础。ELF格式是在<code>UNIX System V</code>中引入的，用来支持<code>C++</code>和动态链接，他的前身是<code>a.out</code>格式。现在ELF被广泛用于Linux、BSD等类UNIX系统。下面是一些常见的目标文件格式，有关这些格式的详细说明，可以参考相关文档或《链接器和加载器》第3章。</p>
<ul>
<li>空目标文件格式：MS-DOS的COM文件</li>
<li>代码区段：UNIX的a.out文件</li>
<li>重定位：MS-DOS的EXE文件</li>
<li>可重定位的a.out格式</li>
<li>UNIX的ELF格式</li>
<li>IBM 360目标格式</li>
<li>微软PE格式</li>
<li>Intel/Microsoft的OMF文件格式</li>
</ul>
<h2 id="ELF学习资料"><a class="header-anchor" href="#ELF学习资料">¶</a>ELF学习资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://share.pkemb.com/books/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB--%E9%93%BE%E6%8E%A5%E3%80%81%E8%A3%85%E8%BD%BD%E4%B8%8E%E5%BA%93%20-%20%E4%BF%9E%E7%94%B2%E5%AD%90.pdf">程序员的自我修养–链接、装载与库 - 俞甲子</a></li>
<li><a target="_blank" rel="noopener" href="https://share.pkemb.com/books/%E9%93%BE%E6%8E%A5%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%88%E6%89%AB%E6%8F%8F%E7%89%88%EF%BC%89%20-%20John%20R.%20Levine.pdf">链接器和加载器</a></li>
<li><a target="_blank" rel="noopener" href="https://share.pkemb.com/books/elf%20specification%20v1.2.pdf">elf specification v1.2.pdf</a></li>
</ul>
<h2 id="示例代码"><a class="header-anchor" href="#示例代码">¶</a>示例代码</h2>
<p>为了更好的理解ELF文件格式，会使用以下代码编译出来的文件作演示。编译完成之后，会得到两个文件<code>tiny_hello.o</code>和<code>tiny_hello</code>。代码和<code>Makefile</code>可以从网页<a target="_blank" rel="noopener" href="https://gist.github.com/pkemb/68dd3303dfd53e6ec400e961848c4547">tiny_hello</a>获取。注意，这份代码需要在32位Linux系统上运行。</p>
<p>编译指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -g -fno-builtin tiny_hello.c</span><br><span class="line">ld -static -e nomain tiny_hello.o -o tiny_hello</span><br></pre></td></tr></table></figure>
<p>源代码和Makefile如下：</p>
<script src="https://gist.github.com/pkemb/68dd3303dfd53e6ec400e961848c4547.js"></script>
<h2 id="ELF-文件类型"><a class="header-anchor" href="#ELF-文件类型">¶</a>ELF 文件类型</h2>
<p>ELF将文件分为4类，下表对比了不同类型之间的差异。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>链接</th>
<th>加载</th>
<th>示例文件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>可重定位文件</td>
<td>Y</td>
<td>N</td>
<td>tiny_hello.o</td>
<td>由编译器和汇编器创建，运行前需要被链接器处理。</td>
</tr>
<tr>
<td>可执行文件</td>
<td>N</td>
<td>Y</td>
<td>tiny_hello</td>
<td>完成了所有的重定位工作和符号解析（除共享库符号）。</td>
</tr>
<tr>
<td>共享目标文件</td>
<td>Y</td>
<td>Y</td>
<td>libc.so.6</td>
<td>即包括链接器需要的符号信息，也包括运行时可以直接执行的代码。</td>
</tr>
<tr>
<td>核心转储文件</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>编译器、汇编器和链接器将ELF文件看作是<code>Section header table</code>描述的一系列逻辑<code>区段</code>（<code>section</code>）的集合；加载器将ELF文件看作是<code>Program header table</code>描述的一系列<code>段</code>（<code>segment</code>）的集合。一个<code>段</code>通常由多个<code>区段</code>组合。可重定位文件有<code>Section header table</code>，可执行文件有<code>Program header table</code>，共享目标文件两者都有。</p>
<p><img src="https://raw.githubusercontent.com/pkemb/notes/master/books/9787121085116/pic/ELF%E7%9A%84%E9%93%BE%E6%8E%A5%E5%92%8C%E6%89%A7%E8%A1%8C%E8%A7%86%E5%9B%BE.png" alt=""></p>
<h2 id="ELF-文件头"><a class="header-anchor" href="#ELF-文件头">¶</a>ELF 文件头</h2>
<p>ELF文件都以ELF文件头开始，在32位机器上通过结构体<code>Elf32_Ehdr</code>来描述。重点关注<code>e_shoff</code>和<code>e_phoff</code>，通过这两个字段可以寻找到区段头部表和程序头部表，从而可以定位到其余所有的区段和段。</p>
<p><img src="https://raw.githubusercontent.com/pkemb/notes/master/books/9787121085116/pic/elf_header.png" alt=""></p>
<p>通过通过指令<code>readelf -h elffile</code>来查看ELF文件头。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF32</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Intel 80386</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          1464 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               52 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           40 (bytes)</span><br><span class="line">  Number of section headers:         25</span><br><span class="line">  Section header string table index: 22</span><br></pre></td></tr></table></figure>
<h2 id="可重定位文件"><a class="header-anchor" href="#可重定位文件">¶</a>可重定位文件</h2>
<p>可重定位文件可以看作是一系列在区段头部表（Section header table）中被定义的区段的集合。区段头部表是一个以<code>Elf32_Shdr</code>结构体为元素的数组，数组中的每一个元素对应一个段。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>sh_name</td>
<td>区段名，存储在区段<code>.shstrtab</code>的偏移。</td>
</tr>
<tr>
<td>sh_type</td>
<td><a href="#%E5%8C%BA%E6%AE%B5%E7%B1%BB%E5%9E%8B">区段类型</a></td>
</tr>
<tr>
<td>sh_flags</td>
<td><a href="#%E5%8C%BA%E6%AE%B5%E6%A0%87%E5%BF%97%E4%BD%8D">区段标志位</a></td>
</tr>
<tr>
<td>sh_addr</td>
<td>可加载区段在进程地址空间中的虚拟地址，不可加载区段为0。</td>
</tr>
<tr>
<td>sh_offset</td>
<td>区段在文件中的偏移。区段不在文件中则为0。</td>
</tr>
<tr>
<td>sh_size</td>
<td>区段的长度。</td>
</tr>
<tr>
<td>sh_link</td>
<td>段链接信息，存储的是相关信息的区段号。</td>
</tr>
<tr>
<td>sh_info</td>
<td>区段更多的信息。</td>
</tr>
<tr>
<td>sh_addralign</td>
<td>段地址对齐，2的指数倍。</td>
</tr>
<tr>
<td>sh_entsize</td>
<td>区段为一个表时，表项的大小。</td>
</tr>
</tbody>
</table>
<h3 id="区段类型"><a class="header-anchor" href="#区段类型">¶</a>区段类型</h3>
<p>区段常见的类型有：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>SHT_PROGBITS</td>
<td>程序内容，包括代码、数据和调试器信息。</td>
</tr>
<tr>
<td>SHT_NOBITS</td>
<td>在文件中没有分配空间，在程序加载时分配空间，例如.bss区段。</td>
</tr>
<tr>
<td>SHT_SYMTAB / SHT_DNYSYM</td>
<td><a href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8">符号表</a>。SHT_SYMBAT包含所有的符号，SHT_DNYSYM包含动态链接的符号，会被加载到内存。<br> readelf -s <br> objdump -t</td>
</tr>
<tr>
<td>SHT_STRTAB</td>
<td>字符串表。</td>
</tr>
<tr>
<td>SHT_REL / SHT_RELA</td>
<td>重定位表，包含重定位信息。<br> objdump -r <br> objdump -R</td>
</tr>
<tr>
<td>SHT_DYNAMIC</td>
<td>动态链接信息。<br> readelf -d</td>
</tr>
<tr>
<td>SHT_HASH</td>
<td>哈希表。</td>
</tr>
</tbody>
</table>
<h3 id="区段标志位"><a class="header-anchor" href="#区段标志位">¶</a>区段标志位</h3>
<p>区段标志位表示该区段在进程虚拟地址空间中的属性。</p>
<table>
<thead>
<tr>
<th>标志</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>SHF_WRITE</td>
<td>在进程空间中可写。</td>
</tr>
<tr>
<td>SHF_ALLOC</td>
<td>在进程空间中要分配空间。</td>
</tr>
<tr>
<td>SHF_EXECINSTR</td>
<td>在进程空间中可以被执行。</td>
</tr>
</tbody>
</table>
<p>根据区段类型和区段标志位的组合，ELF文件可能有如下区段：</p>
<ul>
<li>.text，正文段，具有ALLOC+EXECINSTR属性的PROGBITS类型区段。</li>
<li>.data，数据段，具有ALLOC+WRITE属性的PROGBITS类型区段。</li>
<li>.rodata，只读数据段，具有ALLOC属性的PROGBITS类型区段。</li>
<li>.bss，具有ALLOC+WRITE属性的NOBITS类型区段。</li>
<li>.rel.text, .rel.data, .rel.rodata，REL或RELA类型区段，包含对应区段的重定位信息。</li>
<li>.init和.fini，具有ALLOC+EXECINSTR属性的PROGBITS类型区段，对C++来说时必须的。</li>
<li>.symtab，符号表，SYMTAB类型的区段。</li>
<li>.dnysym，动态链接符号表，具有ALLOC属性的DNYSYM类型区段。</li>
<li>.strtab，字符串表，STRTAB类型的区段，通常保存符号的字符串。</li>
<li>.shstrtab，段表字符串表，通常存储段名字符串。</li>
<li>.dnystr，ALLOC属性的STRTAB类型区段，通常保存动态链接符号的字符串。</li>
<li>.got</li>
<li>.plt</li>
<li>.line</li>
<li>.comment</li>
<li>.interp</li>
</ul>
<h3 id="区段头部表示例"><a class="header-anchor" href="#区段头部表示例">¶</a>区段头部表示例</h3>
<p>可以使用指令<code>readelf -S elffile </code>或<code>objdump -h elffile</code>，查看区段头部表。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">There are 25 section headers, starting at offset 0x5b8:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .text             PROGBITS        00000000 000034 000049 00  AX  0   0  4</span><br><span class="line">  [ 2] .rel.text         REL             00000000 000bd4 000018 08     23   1  4</span><br><span class="line">  [ 3] .data             PROGBITS        00000000 000080 000010 00  WA  0   0  4</span><br><span class="line">  [ 4] .rel.data         REL             00000000 000bec 000008 08     23   3  4</span><br><span class="line">  [ 5] .bss              NOBITS          00000000 000090 000008 00  WA  0   0  4</span><br><span class="line">  [ 6] .debug_abbrev     PROGBITS        00000000 000090 00008c 00      0   0  1</span><br><span class="line">  [ 7] .debug_info       PROGBITS        00000000 00011c 000111 00      0   0  1</span><br><span class="line">  [ 8] .rel.debug_info   REL             00000000 000bf4 000118 08     23   7  4</span><br><span class="line">  [ 9] .debug_line       PROGBITS        00000000 00022d 000045 00      0   0  1</span><br><span class="line">  [10] .rel.debug_line   REL             00000000 000d0c 000008 08     23   9  4</span><br><span class="line">  [11] .rodata           PROGBITS        00000000 000272 000007 00   A  0   0  1</span><br><span class="line">  [12] .debug_frame      PROGBITS        00000000 00027c 000060 00      0   0  4</span><br><span class="line">  [13] .rel.debug_frame  REL             00000000 000d14 000030 08     23  12  4</span><br><span class="line">  [14] .debug_loc        PROGBITS        00000000 0002dc 000084 00      0   0  1</span><br><span class="line">  [15] .debug_pubnames   PROGBITS        00000000 000360 00005a 00      0   0  1</span><br><span class="line">  [16] .rel.debug_pubnam REL             00000000 000d44 000008 08     23  15  4</span><br><span class="line">  [17] .debug_aranges    PROGBITS        00000000 0003ba 000020 00      0   0  1</span><br><span class="line">  [18] .rel.debug_arange REL             00000000 000d4c 000010 08     23  17  4</span><br><span class="line">  [19] .debug_str        PROGBITS        00000000 0003da 0000df 01  MS  0   0  1</span><br><span class="line">  [20] .comment          PROGBITS        00000000 0004b9 00002d 00      0   0  1</span><br><span class="line">  [21] .note.GNU-stack   PROGBITS        00000000 0004e6 000000 00      0   0  1</span><br><span class="line">  [22] .shstrtab         STRTAB          00000000 0004e6 0000d1 00      0   0  1</span><br><span class="line">  [23] .symtab           SYMTAB          00000000 0009a0 0001a0 10     24  20  4</span><br><span class="line">  [24] .strtab           STRTAB          00000000 000b40 000094 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure>
<h2 id="可执行文件"><a class="header-anchor" href="#可执行文件">¶</a>可执行文件</h2>
<p>程序头部表（Program Header table）是一个以<code>Elf32_Phdr</code>结构体为元素的数组，定义了要被映射的段。为了加快映射的速度，可执行文件将类似的可加载<code>区段</code>合并为一个<code>段</code>。可执行文件通常只有少数几种段，例如可读可执行的代码段，可读可写的数据段，只读的只读数据段。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>p_type</td>
<td>段的类型。LOAD、DYNAMIC、INTERP等。</td>
</tr>
<tr>
<td>p_offset</td>
<td>段在文件中的偏移。</td>
</tr>
<tr>
<td>p_vaddr</td>
<td>段在进程虚拟地址空间的起始地址。</td>
</tr>
<tr>
<td>p_paddr</td>
<td>物理装载地址。</td>
</tr>
<tr>
<td>p_filesz</td>
<td>段在文件中所占空间的大小。</td>
</tr>
<tr>
<td>p_memsz</td>
<td>段在虚拟地址空间中所占用的长度。</td>
</tr>
<tr>
<td>p_flags</td>
<td>段的权限，RWX。</td>
</tr>
<tr>
<td>p_align</td>
<td>对齐，2的指数幂。</td>
</tr>
</tbody>
</table>
<h3 id="程序头部表示例"><a class="header-anchor" href="#程序头部表示例">¶</a>程序头部表示例</h3>
<p>可以使用指令<code>readelf -l execfile</code>查看程序头表。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ readelf -l tiny_hello</span><br><span class="line"></span><br><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point 0x80480c4</span><br><span class="line">There are 3 program headers, starting at offset 52</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span><br><span class="line">  LOAD           0x000000 0x08048000 0x08048000 0x000e4 0x000e4 R E 0x1000</span><br><span class="line">  LOAD           0x0000e4 0x080490e4 0x080490e4 0x00010 0x0001c RW  0x1000</span><br><span class="line">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .text .rodata</span><br><span class="line">   01     .data .bss</span><br><span class="line">   02</span><br></pre></td></tr></table></figure>
<h2 id="ELF共享目标文件"><a class="header-anchor" href="#ELF共享目标文件">¶</a>ELF共享目标文件</h2>
<p>ELF第三种文件类型是共享目标文件，它包含了可重定位文件和可执行文件的所有东西。也就是说，共享目标文件既可以参与链接，也可以被加载到内容中执行。除此之外，共享目标文件还有一些独有的段，例如<code>.got</code>、<code>.plt</code>、<code>.interp</code>等。</p>
<h2 id="常见区段"><a class="header-anchor" href="#常见区段">¶</a>常见区段</h2>
<p>常见区段以及查看区段数据的指令。</p>
<h3 id="符号表"><a class="header-anchor" href="#符号表">¶</a>符号表</h3>
<p>符号表存储了ELF文件中每个符号的相关信息，是一个非常重要的表。通过符号表，可以得到非常多有用的信息，是分析ELF文件的基础。符号表是<code>Elf32_Sym</code>结构体数组，段名一般叫<code>.symtab</code>，每个表项定义了一个符号。</p>
<ul>
<li>st_name：符号名，字符串表<code>.strtab</code>的下标。</li>
<li>st_size：符号大小。</li>
<li>st_shndx：符号所在的段。
<ul>
<li>符号所在的段在段表中的下标。</li>
<li>SHN_ABS：该符号包含了一个绝对的值，例如文件名的符号。</li>
<li>SHN_COMMON：该符号是一个“COMMON块”类型的符号，例如未初始化的全局符号定义。</li>
<li>SHN_UNDEF：符号未定义，该符号在本文件中被引用，但是定义在其他文件。</li>
</ul>
</li>
<li>st_info：符号类型和绑定信息
<ul>
<li>高28位表示符号绑定信息（Symbol Binding）
<ul>
<li>STB_LOCAL：局部符号，对目标文件的外部不可见。</li>
<li>STB_GLOBAL：全局符号，外部可见。</li>
<li>STB_WEAK：若引用。</li>
</ul>
</li>
<li>低4位表示符号的类型（Symbol Type）
<ul>
<li>STT_NOTYPE：未知类型符号</li>
<li>STT_OBJECT：该符号是一个数据对象，比如变量、数组。</li>
<li>STT_FUNC：该符号是函数或其他可执行代码。</li>
<li>STT_SECTION：该符号是一个段，一定是STB_LOCAL。</li>
<li>STT_FILE：目标文件对应的源文件名，一定是STB_LOCAL，st_shndx一定是SHN_ABS。</li>
</ul>
</li>
</ul>
</li>
<li>st_value：符号值
<ul>
<li>目标文件
<ul>
<li>SHN_UNDEF：st_value没有用。</li>
<li>SHN_COMMON：表示该符号的对齐属性。</li>
<li>段的下标：st_value表示该符号在段中的偏移位置。</li>
</ul>
</li>
<li>可执行文件
<ul>
<li>st_value表示符号的虚拟地址。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="符号表示例"><a class="header-anchor" href="#符号表示例">¶</a>符号表示例</h4>
<p>可以使用指令<code>readelf -s elffile</code>查看符号表中的每一个表项。输出的第一列（Num）是符号在符号表的索引，第二列（Value）是符号值，第三列（Size）是符号大小，第四列（Type）是符号类型，第五列（Bind）是绑定类型，第六列（Vis）是??，第七列是（Ndx）是符号所在的段，第八列（Name）是符号名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ readelf -s tiny_hello</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 28 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 08048094     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     2: 080480dd     0 SECTION LOCAL  DEFAULT    2</span><br><span class="line">     3: 080490e4     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 080490f4     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    7</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    8</span><br><span class="line">     9: 00000000     0 SECTION LOCAL  DEFAULT    9</span><br><span class="line">    10: 00000000     0 SECTION LOCAL  DEFAULT   10</span><br><span class="line">    11: 00000000     0 SECTION LOCAL  DEFAULT   11</span><br><span class="line">    12: 00000000     0 SECTION LOCAL  DEFAULT   12</span><br><span class="line">    13: 00000000     0 SECTION LOCAL  DEFAULT   13</span><br><span class="line">    14: 00000000     0 FILE    LOCAL  DEFAULT  ABS tiny_hello.c</span><br><span class="line">    15: 080490e8     4 OBJECT  LOCAL  DEFAULT    3 global_static_init</span><br><span class="line">    16: 080490f0     4 OBJECT  LOCAL  DEFAULT    3 local_static_init.763</span><br><span class="line">    17: 080490f4     4 OBJECT  LOCAL  DEFAULT    4 local_static_uninit.762</span><br><span class="line">    18: 080490f8     4 OBJECT  LOCAL  DEFAULT    4 global_static_uninit</span><br><span class="line">    19: 08048094    31 FUNC    GLOBAL DEFAULT    1 print</span><br><span class="line">    20: 080490e4     4 OBJECT  GLOBAL DEFAULT    3 global_init</span><br><span class="line">    21: 080480c4    25 FUNC    GLOBAL DEFAULT    1 nomain</span><br><span class="line">    22: 080490fc     4 OBJECT  GLOBAL DEFAULT    4 global_uninit</span><br><span class="line">    23: 080490f4     0 NOTYPE  GLOBAL DEFAULT  ABS __bss_start</span><br><span class="line">    24: 080490f4     0 NOTYPE  GLOBAL DEFAULT  ABS _edata</span><br><span class="line">    25: 08049100     0 NOTYPE  GLOBAL DEFAULT  ABS _end</span><br><span class="line">    26: 080490ec     4 OBJECT  GLOBAL DEFAULT    3 str</span><br><span class="line">    27: 080480b3    17 FUNC    GLOBAL DEFAULT    1 exit</span><br></pre></td></tr></table></figure>
<h3 id="代码段"><a class="header-anchor" href="#代码段">¶</a>代码段</h3>
<p>代码段存储了机器码，常见的代码段有<code>.text</code>、<code>.init</code>、<code>.fini</code>等。可以通过指令<code>objdump -d elffile</code>查看反汇编之后的代码，选项<code>-j section_name</code>可用于反汇编指定段。<code>objdump -S elffile</code>同时显示C代码和反汇编代码，这需要使用<code>-g</code>参数编译。<code>objdump -s elffile -j .text</code>查看<code>.text</code>段的十六进制内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ objdump -d tiny_hello -j .text</span><br><span class="line"></span><br><span class="line">tiny_hello:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">08048094 &lt;print&gt;:</span><br><span class="line"> 8048094:       55                      push   %ebp</span><br><span class="line"> 8048095:       89 e5                   mov    %esp,%ebp</span><br><span class="line"> 8048097:       53                      push   %ebx</span><br><span class="line"> 8048098:       a1 ec 90 04 08          mov    0x80490ec,%eax</span><br><span class="line"> 804809d:       ba 06 00 00 00          mov    $0x6,%edx</span><br><span class="line"> 80480a2:       89 c1                   mov    %eax,%ecx</span><br><span class="line"> 80480a4:       bb 01 00 00 00          mov    $0x1,%ebx</span><br><span class="line"> 80480a9:       b8 04 00 00 00          mov    $0x4,%eax</span><br><span class="line"> 80480ae:       cd 80                   int    $0x80</span><br><span class="line"> 80480b0:       5b                      pop    %ebx</span><br><span class="line"> 80480b1:       5d                      pop    %ebp</span><br><span class="line"> 80480b2:       c3                      ret</span><br><span class="line"></span><br><span class="line">省略exit和nomain函数的反汇编代码......</span><br></pre></td></tr></table></figure>
<p>有时候只需要查看某个函数的反汇编代码，而不是段中所有函数的反汇编代码。这可以通过<code>gdb</code>来完成。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb /bin/ls -batch -ex &#x27;disassemble main&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="数据段"><a class="header-anchor" href="#数据段">¶</a>数据段</h3>
<p>数据段存储了全局或静态变量的初始值，常见的数据段有<code>.data</code>和<code>.rodata</code>，<code>.data</code>存储可读写的数据，<code>.rodata</code>存储只读数据。数据段只是简单的将各个变量的初始值罗列在一起，所以只能直接查看其二进制的值。还有一个特殊的数据段是<code>.bss</code>，在可执行文件中不占用空间，只在虚拟内存中占用空间，在<code>.bss</code>段中的变量，初始值都是0。可以使用指令<code>objdump -s elffile -j .data</code>查看数据段的十六进制内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ objdump -s tiny_hello -j .data -j .rodata</span><br><span class="line"></span><br><span class="line">tiny_hello:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> 80480dd 68656c6c 6f0a00                      hello..</span><br><span class="line">Contents of section .data:</span><br><span class="line"> 80490e4 02000000 03000000 dd800408 05000000  ................</span><br></pre></td></tr></table></figure>
<h3 id="字符串表"><a class="header-anchor" href="#字符串表">¶</a>字符串表</h3>
<p>字符串存储了变量、函数、段名的字符串。一般情况下，<code>.strtab</code>存储了变量和函数的名称，<code>.shstrtab</code>存储了各个段的名称，<code>.dnystr</code>存储了需要动态链接的变量和函数的名称，是<code>.strtab</code>的子集，且只在动态库文件中存在。可以使用指令<code>readelf elffile -p section</code>查看字符串表中的内容。字符串前方的数字是字符串第一个字符在字符串表中的偏移。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ readelf tiny_hello -p .strtab -p .shstrtab</span><br><span class="line"></span><br><span class="line">String dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  [     1]  .symtab</span><br><span class="line">  [     9]  .strtab</span><br><span class="line">  [    11]  .shstrtab</span><br><span class="line">  [    1b]  .text</span><br><span class="line">  [    21]  .rodata</span><br><span class="line">  [    29]  .data</span><br><span class="line">  [    2f]  .bss</span><br><span class="line">  [    34]  .comment</span><br><span class="line">  [    3d]  .debug_aranges</span><br><span class="line">  [    4c]  .debug_pubnames</span><br><span class="line">  [    5c]  .debug_info</span><br><span class="line">  [    68]  .debug_abbrev</span><br><span class="line">  [    76]  .debug_line</span><br><span class="line">  [    82]  .debug_frame</span><br><span class="line">  [    8f]  .debug_str</span><br><span class="line">  [    9a]  .debug_loc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">String dump of section &#x27;.strtab&#x27;:</span><br><span class="line">  [     1]  tiny_hello.c</span><br><span class="line">  [     e]  global_static_init</span><br><span class="line">  [    21]  local_static_init.763</span><br><span class="line">  [    37]  local_static_uninit.762</span><br><span class="line">  [    4f]  global_static_uninit</span><br><span class="line">  [    64]  print</span><br><span class="line">  [    6a]  global_init</span><br><span class="line">  [    76]  nomain</span><br><span class="line">  [    7d]  global_uninit</span><br><span class="line">  [    8b]  __bss_start</span><br><span class="line">  [    97]  _edata</span><br><span class="line">  [    9e]  _end</span><br><span class="line">  [    a3]  str</span><br><span class="line">  [    a7]  exit</span><br></pre></td></tr></table></figure>
<h2 id="ELF实例分析"><a class="header-anchor" href="#ELF实例分析">¶</a>ELF实例分析</h2>
<p>分析一个ELF文件，目的是为了从中获取到一些有用的信息。由于可重定位文件、可执行文件和共享库文件有不同的特点，所以关注的侧重点也不同。对于可重定位和共享库文件来说，可以参与链接，所以比较关心它们的导出、导入符号。对于可执行文件和共享库文件来说，还可以被加载到内存中运行，比较关心加载地址、（虚拟）内存布局、依赖的动态库（动态链接）。</p>
<p>以<code>tiny_hello</code>为例，简单分析一下ELF可执行文件。首先从文件头可以看到程序的入口地址，这是程序开始运行的地方。通过<code>section headers</code>的入口地址、大小以及数量，可以找到其余所有区段的位置。通过<code>program headers</code>的入口地址、大小及数量，可以确定所有可加载段的位置。通过<code>shstrtab</code>的索引，可以确定每个区段的名字。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ readelf -h tiny_hello</span><br><span class="line">......</span><br><span class="line">  Entry point address:               0x80480c4</span><br><span class="line">  Start of program headers:          52 (bytes into file)</span><br><span class="line">  Start of section headers:          1512 (bytes into file)</span><br><span class="line">  Size of program headers:           32 (bytes)</span><br><span class="line">  Number of program headers:         3</span><br><span class="line">  Size of section headers:           40 (bytes)</span><br><span class="line">  Number of section headers:         17</span><br><span class="line">  Section header string table index: 14</span><br></pre></td></tr></table></figure>
<p>由于可执行文件是可加载的，接下来看看<code>program headers</code>。从表中可以看出，有两个可加载的<code>segment</code>。第一个<code>segment</code>由<code>.text</code>和<code>.rodata</code>组合而成，包含一些只读的代码和数据。第二个<code>segment</code>由<code>.data</code>和<code>.bss</code>组合而成，包含一些可读写的数据。首先来看看<code>FileSiz</code>和<code>MemSiz</code>，分别表示在文件中占用的空间和在内存中占用的空间。第一个<code>segment</code>两者一致，第二个<code>Segment</code>的<code>MemSiz</code>稍大一些，这是因为<code>.bss</code>在文件中不占用空间，只占用内存中的空间。接下来分析<code>VirtAddr</code>和<code>PhyAddr</code>，分别表示虚拟地址和物理地址。一般情况下，两者的大小是一致的，在一些特殊的情况，比如bootloader、kernel、单片机程序中，两者可能不一致。</p>
<blockquote>
<p>为什么第二个<code>segment</code>的加载地址，是从<code>0x080490e4</code>开始，而不是<code>0x08049000</code>开始呢？</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ readelf tiny_hello -l</span><br><span class="line">There are 3 program headers, starting at offset 52</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span><br><span class="line">  LOAD           0x000000 0x08048000 0x08048000 0x000e4 0x000e4 R E 0x1000</span><br><span class="line">  LOAD           0x0000e4 0x080490e4 0x080490e4 0x00010 0x0001c RW  0x1000</span><br><span class="line">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .text .rodata</span><br><span class="line">   01     .data .bss</span><br><span class="line">   02</span><br></pre></td></tr></table></figure>
<p>为了弄清楚内存中的内容，需要看看符号表中的内容。下面的符号表已将不需要的内容删除了，并重新排序了。有三个类型为<code>FUNC</code>的符号，均在区段1，即<code>.text</code>区段。而且全部都是<code>GLOBAL</code>类型的符号，说明从外部是可见的。</p>
<p>重点在7个类型为<code>OBJECT</code>的符号。带有<code>static</code>的符号，均是<code>LOCAL</code>；不带<code>static</code>的符号均是<code>GLOBAL</code>。带有<code>uninit</code>的符号，均在区段4，即<code>.bss</code>区段；带有<code>init</code>的符号，均在区段3，即<code>.data</code>区段。对比源代码可以看出，<code>nomain()</code>定义的<code>local_init</code>和<code>local_uninit</code>变量没有出现到符号表中，因为这两个变量运行时在栈中分配空间，所以符号表中没有。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ readelf tiny_hello -s</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 28 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">    21: 080480c4    25 FUNC    GLOBAL DEFAULT    1 nomain</span><br><span class="line">    19: 08048094    31 FUNC    GLOBAL DEFAULT    1 print</span><br><span class="line">    27: 080480b3    17 FUNC    GLOBAL DEFAULT    1 exit</span><br><span class="line"></span><br><span class="line">    15: 080490e8     4 OBJECT  LOCAL  DEFAULT    3 global_static_init</span><br><span class="line">    16: 080490f0     4 OBJECT  LOCAL  DEFAULT    3 local_static_init.763</span><br><span class="line">    17: 080490f4     4 OBJECT  LOCAL  DEFAULT    4 local_static_uninit.762</span><br><span class="line">    18: 080490f8     4 OBJECT  LOCAL  DEFAULT    4 global_static_uninit</span><br><span class="line">    20: 080490e4     4 OBJECT  GLOBAL DEFAULT    3 global_init</span><br><span class="line">    22: 080490fc     4 OBJECT  GLOBAL DEFAULT    4 global_uninit</span><br><span class="line">    26: 080490ec     4 OBJECT  GLOBAL DEFAULT    3 str</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">080480c4 &lt;nomain&gt;:</span><br><span class="line"> 80480c4:       55                      push   %ebp</span><br><span class="line"> 80480c5:       89 e5                   mov    %esp,%ebp</span><br><span class="line"> 80480c7:       83 ec 10                sub    $0x10,%esp       # 栈指针减少0x10，为了4个int型变量预留栈空间</span><br><span class="line"> 80480ca:       c7 45 fc 04 00 00 00    movl   $0x4,-0x4(%ebp)  # 赋值为4</span><br><span class="line"> 80480d1:       e8 be ff ff ff          call   8048094 &lt;print&gt;</span><br><span class="line"> 80480d6:       e8 d8 ff ff ff          call   80480b3 &lt;exit&gt;</span><br><span class="line"> 80480db:       c9                      leave</span><br><span class="line"> 80480dc:       c3                      ret</span><br></pre></td></tr></table></figure>
<p>对符号表的分析可以看出，有4个变量定义在了<code>.data</code>段，来看看<code>.data</code>段中的内容。<code>.data</code>段从<code>0x080490e4</code>开始，数据段中的值可以与符号表对上。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[pk@localhost tiny_hello]$ objdump tiny_hello -s -j .data</span><br><span class="line"></span><br><span class="line">tiny_hello:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Contents of section .data:</span><br><span class="line"> 80490e4 02000000 03000000 dd800408 05000000  ................</span><br></pre></td></tr></table></figure>
<p>以上分析了ELF可执行文件的入口地址、内存布局以及如何查看数据段的内容。</p>
<h2 id="小结"><a class="header-anchor" href="#小结">¶</a>小结</h2>
<p>本文以<code>tiny_hello.c</code>编译出来的目标文件和可执行文件为例子，利用<code>objdump</code>和<code>readelf</code>工具，分析了ELF文件的格式，并对常见区段的内容进行了重点讲解。然而，以上没有包含ELF格式的所有内容，还有重定位表、<code>.got</code>、<code>.plt</code>和<code>.interp</code>等内容没有介绍，这些内容会和链接、动态库一起介绍。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/excel-common-print-setting/" rel="prev" title="Excel常见打印设置">
      <i class="fa fa-chevron-left"></i> Excel常见打印设置
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/05/elf-analysis-command/" rel="next" title="ELF分析常用指令">
      ELF分析常用指令 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">ELF文件格式概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99"><span class="nav-number">2.</span> <span class="nav-text">ELF学习资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">3.</span> <span class="nav-text">示例代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF-%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.</span> <span class="nav-text">ELF 文件类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF-%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="nav-number">5.</span> <span class="nav-text">ELF 文件头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E9%87%8D%E5%AE%9A%E4%BD%8D%E6%96%87%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text">可重定位文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.1.</span> <span class="nav-text">区段类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E6%AE%B5%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="nav-number">6.2.</span> <span class="nav-text">区段标志位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E6%AE%B5%E5%A4%B4%E9%83%A8%E8%A1%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.3.</span> <span class="nav-text">区段头部表示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="nav-number">7.</span> <span class="nav-text">可执行文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E5%A4%B4%E9%83%A8%E8%A1%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">7.1.</span> <span class="nav-text">程序头部表示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF%E5%85%B1%E4%BA%AB%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="nav-number">8.</span> <span class="nav-text">ELF共享目标文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%8C%BA%E6%AE%B5"><span class="nav-number">9.</span> <span class="nav-text">常见区段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="nav-number">9.1.</span> <span class="nav-text">符号表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">9.1.1.</span> <span class="nav-text">符号表示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%AE%B5"><span class="nav-number">9.2.</span> <span class="nav-text">代码段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%AE%B5"><span class="nav-number">9.3.</span> <span class="nav-text">数据段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A1%A8"><span class="nav-number">9.4.</span> <span class="nav-text">字符串表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-number">10.</span> <span class="nav-text">ELF实例分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">11.</span> <span class="nav-text">小结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="pkemb"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">pkemb</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/pkemb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;pkemb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:pkemb@outlook.com" title="E-Mail → mailto:pkemb@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">湘ICP备2021012928号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pkemb</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">239k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:37</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'f46a55be4b1f1411ba22',
      clientSecret: '68eee1bc3bd649a399bde3be81cd73aa43dd7a79',
      repo        : 'pkemb.github.io',
      owner       : 'pkemb',
      admin       : ['pkemb'],
      id          : 'ed972d1db2512514845e6f15291c6357',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
